syntax = "proto2";

package rpc;

service Coordinator {
  rpc Check (CheckRequest) returns (CheckResponse) {}
  rpc Submit (SubmitRequest) returns (SubmitResponse) {}
  rpc Trace (TraceRequest) returns (TraceResponse) {}
}

message SubmitRequest {
  required string sql = 1;
  map<string, bytes> variables = 2;
}

message SubmitResponse {
  required int64 txn = 1;
  repeated TraceRequest trace = 2;
  required bytes record_batch = 3;
}

message TraceRequest {
  required int64 txn = 1;
  required int32 stage = 2;
  required int32 worker = 3;
  repeated TraceEvent events = 4;
}

message TraceEvent {
  required string name = 1;
  required uint64 begin = 2;
  required uint64 end = 3;
}

message TraceResponse {}

service Worker {
  rpc Check (CheckRequest) returns (CheckResponse) {}
  rpc Broadcast (BroadcastRequest) returns (stream Page) {}
  rpc Exchange (ExchangeRequest) returns (stream Page) {}
  rpc ApproxCardinality (ApproxCardinalityRequest) returns (ApproxCardinalityResponse) {}
  rpc ColumnStatistics (ColumnStatisticsRequest) returns (ColumnStatisticsResponse) {}
}

message CheckRequest {}
message CheckResponse {}

message BroadcastRequest {
  required int64 txn = 1;
  required int32 stage = 2;
  required bytes expr = 3;
  map<string, bytes> variables = 4;
  required int32 listeners = 5;
}

message ExchangeRequest {
  required int64 txn = 1;
  required int32 stage = 2;
  required bytes expr = 3;
  map<string, bytes> variables = 4;
  required int32 listeners = 5;
  required string hash_column = 6;
  required int32 hash_bucket = 7;
}

message Page {
  oneof part {
    bytes record_batch = 1;
    string error = 2;
  }
}

message ApproxCardinalityRequest {
  required int64 table_id = 1;
}

message ApproxCardinalityResponse {
  required double cardinality = 1;
}

message ColumnStatisticsRequest {
  required int64 table_id = 1;
  required string column_name = 2;
}

message ColumnStatisticsResponse {
  optional bytes statistics = 1;
}