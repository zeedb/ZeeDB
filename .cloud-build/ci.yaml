steps:
  - name: gcr.io/$PROJECT_ID/zeedb-builder
    id: build
    waitFor: ['-']
    entrypoint: sh
    args: [-c, 'cargo test -Z timings --all-targets --no-run && sccache --show-stats']
  - name: gcr.io/cloud-builders/docker
    id: zetasql
    waitFor: ['-']
    args: [run, -d, --network=cloudbuild, --name=zetasql, gcr.io/$PROJECT_ID/zetasql]
  - name: gcr.io/$PROJECT_ID/zeedb-builder
    id: test
    waitFor: [build, zetasql]
    entrypoint: cargo
    args: [test]
artifacts:
  objects:
    location: gs://zeedb-build-artifacts
    paths:
      - cargo-timing.html
options:
  env:
    - RUSTC_WRAPPER=sccache
    - CMAKE_C_COMPILER_LAUNCHER=sccache
    - CMAKE_CXX_COMPILER_LAUNCHER=sccache
    - SCCACHE_GCS_BUCKET=zeedb-build-cache
    - SCCACHE_GCS_OAUTH_URL=http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/697461006037@cloudbuild.gserviceaccount.com/token
    - SCCACHE_GCS_RW_MODE=READ_WRITE
    - CARGO_INCREMENTAL=0
    - CARGO_BUILD_TARGET=x86_64-unknown-linux-gnu
    - CARGO_HOME=/cargo/cache
    - CARGO_TARGET_DIR=/cargo/target
    - NO_RUSTFMT=1
    - ZETASQL=http://zetasql:50051
  volumes: 
    - name: cargo
      path: /cargo
  machineType: E2_HIGHCPU_8
timeout: 3600s